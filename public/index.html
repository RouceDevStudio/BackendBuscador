<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEXUS ‚Äî Neural Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after {
  margin: 0; padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --bg:        #0C0C0E;
  --bg2:       #141417;
  --bg3:       #1C1C21;
  --surface:   rgba(28, 28, 33, 0.85);
  --border:    rgba(255,255,255,0.07);
  --border2:   rgba(255,255,255,0.12);
  --text:      #F0EEE8;
  --text2:     #A8A49C;
  --text3:     #5C5954;
  --accent:    #D4A853;       /* amber warm */
  --accent2:   #E8C074;
  --accent-bg: rgba(212,168,83,0.08);
  --user-bg:   rgba(255,255,255,0.06);
  --user-border:rgba(255,255,255,0.1);
  --ai-bg:     rgba(212,168,83,0.05);
  --ai-border: rgba(212,168,83,0.15);
  --green:     #5CB891;
  --red:       #E5615A;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
  --shadow:    0 8px 32px rgba(0,0,0,0.5);
  --glow:      0 0 24px rgba(212,168,83,0.2);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRELOADER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#preloader {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: #060608;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}

#preloader.hide {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

/* Background grid */
#preloader::before {
  content: '';
  position: absolute;
  inset: 0;
  background-image:
    linear-gradient(rgba(212,168,83,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(212,168,83,0.04) 1px, transparent 1px);
  background-size: 60px 60px;
  animation: gridPulse 2s ease-in-out infinite;
}

@keyframes gridPulse {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

/* Radial glow center */
#preloader::after {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(212,168,83,0.12) 0%, transparent 70%);
  animation: glowBreath 1.5s ease-in-out infinite;
}

@keyframes glowBreath {
  0%, 100% { transform: scale(0.8); opacity: 0.5; }
  50% { transform: scale(1.2); opacity: 1; }
}

/* Letters wrapper */
.pre-letters {
  position: relative;
  z-index: 2;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 32px;
}

.pre-letter {
  font-family: 'Outfit', sans-serif;
  font-size: clamp(52px, 12vw, 88px);
  font-weight: 700;
  letter-spacing: -0.02em;
  color: transparent;
  -webkit-text-stroke: 1.5px rgba(212,168,83,0.4);
  position: relative;
  display: inline-block;
  animation: letterReveal 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
  transform-origin: bottom center;
}

/* Fill animation */
.pre-letter::before {
  content: attr(data-l);
  position: absolute;
  inset: 0;
  color: var(--accent, #D4A853);
  -webkit-text-stroke: 0;
  clip-path: inset(100% 0 0 0);
  animation: fillUp 0.4s ease forwards;
  animation-delay: inherit;
}

/* Pressure/compression animation */
.pre-letter.compress {
  animation: pressureCompression 0.35s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
}

@keyframes letterReveal {
  from {
    opacity: 0;
    transform: translateY(40px) scaleY(0.3);
    filter: blur(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0) scaleY(1);
    filter: blur(0);
  }
}

@keyframes fillUp {
  to { clip-path: inset(0% 0 0 0); }
}

@keyframes pressureCompression {
  0% { transform: scaleY(1) scaleX(1); }
  20% { transform: scaleY(0.6) scaleX(1.5); filter: brightness(2); }
  40% { transform: scaleY(1.2) scaleX(0.85); }
  60% { transform: scaleY(0.9) scaleX(1.08); }
  80% { transform: scaleY(1.05) scaleX(0.97); }
  100% { transform: scaleY(1) scaleX(1); }
}

/* Individual letter delays */
.pre-letter:nth-child(1) { animation-delay: 0.1s; }
.pre-letter:nth-child(1)::before { animation-delay: 0.1s; }
.pre-letter:nth-child(2) { animation-delay: 0.2s; }
.pre-letter:nth-child(2)::before { animation-delay: 0.2s; }
.pre-letter:nth-child(3) { animation-delay: 0.3s; }
.pre-letter:nth-child(3)::before { animation-delay: 0.3s; }
.pre-letter:nth-child(4) { animation-delay: 0.4s; }
.pre-letter:nth-child(4)::before { animation-delay: 0.4s; }
.pre-letter:nth-child(5) { animation-delay: 0.5s; }
.pre-letter:nth-child(5)::before { animation-delay: 0.5s; }

/* IA badge */
.pre-ia {
  position: relative;
  z-index: 2;
  display: flex;
  align-items: center;
  gap: 3px;
  margin-left: 18px;
  align-self: flex-start;
  margin-top: 10px;
  opacity: 0;
  animation: iaAppear 0.4s ease 0.7s forwards;
}

@keyframes iaAppear {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}

.pre-ia-letter {
  font-family: 'IBM Plex Mono', monospace;
  font-size: clamp(18px, 4vw, 28px);
  font-weight: 500;
  color: #D4A853;
  background: rgba(212,168,83,0.12);
  border: 1px solid rgba(212,168,83,0.3);
  border-radius: 6px;
  padding: 4px 8px;
  position: relative;
  overflow: hidden;
  animation: iaPressure 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97) 0.85s both;
}

.pre-ia-letter::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(212,168,83,0.3) 0%, transparent 60%);
  animation: scanline 1.2s ease 0.9s forwards;
  transform: translateX(-100%);
}

@keyframes scanline {
  to { transform: translateX(200%); }
}

@keyframes iaPressure {
  0% { transform: scale(0) rotate(-15deg); }
  60% { transform: scale(1.3) rotate(3deg); }
  80% { transform: scale(0.9) rotate(-1deg); }
  100% { transform: scale(1) rotate(0deg); }
}

/* Neural lines */
.pre-neural {
  position: absolute;
  inset: 0;
  z-index: 1;
  pointer-events: none;
}

.pre-neural-line {
  position: absolute;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(212,168,83,0.4), transparent);
  animation: neuralScan 1.5s ease-in-out infinite;
  width: 100%;
}

.pre-neural-line:nth-child(1) { top: 20%; animation-delay: 0s; }
.pre-neural-line:nth-child(2) { top: 40%; animation-delay: 0.3s; }
.pre-neural-line:nth-child(3) { top: 60%; animation-delay: 0.6s; }
.pre-neural-line:nth-child(4) { top: 80%; animation-delay: 0.9s; }

@keyframes neuralScan {
  0% { transform: translateX(-100%); opacity: 0; }
  50% { opacity: 1; }
  100% { transform: translateX(100%); opacity: 0; }
}

/* Corner accents */
.pre-corner {
  position: absolute;
  width: 40px;
  height: 40px;
  z-index: 2;
}

.pre-corner::before, .pre-corner::after {
  content: '';
  position: absolute;
  background: var(--accent, #D4A853);
}
.pre-corner::before { width: 100%; height: 1.5px; top: 0; left: 0; }
.pre-corner::after { width: 1.5px; height: 100%; top: 0; left: 0; }

.pre-corner.tl { top: 24px; left: 24px; animation: cornerIn 0.5s ease 0.8s both; }
.pre-corner.tr { top: 24px; right: 24px; transform: rotate(90deg); animation: cornerIn 0.5s ease 0.9s both; }
.pre-corner.bl { bottom: 24px; left: 24px; transform: rotate(-90deg); animation: cornerIn 0.5s ease 1.0s both; }
.pre-corner.br { bottom: 24px; right: 24px; transform: rotate(180deg); animation: cornerIn 0.5s ease 1.1s both; }

@keyframes cornerIn {
  from { opacity: 0; transform-origin: top left; scale: 0; }
  to { opacity: 1; scale: 1; }
}
.pre-corner.tr { transform-origin: top right; }
.pre-corner.bl { transform-origin: bottom left; }
.pre-corner.br { transform-origin: bottom right; }

/* Tagline */
.pre-tagline {
  position: relative;
  z-index: 2;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  letter-spacing: 0.25em;
  color: rgba(212,168,83,0.5);
  text-transform: uppercase;
  opacity: 0;
  animation: tagIn 0.4s ease 1s forwards;
}

@keyframes tagIn {
  from { opacity: 0; letter-spacing: 0.6em; }
  to { opacity: 1; letter-spacing: 0.25em; }
}

/* Loading bar */
.pre-bar-wrap {
  position: relative;
  z-index: 2;
  width: min(320px, 80vw);
  height: 2px;
  background: rgba(212,168,83,0.1);
  border-radius: 2px;
  margin-top: 28px;
  overflow: hidden;
  opacity: 0;
  animation: barIn 0.3s ease 1.1s forwards;
}

@keyframes barIn {
  to { opacity: 1; }
}

.pre-bar {
  height: 100%;
  background: linear-gradient(90deg, #D4A853, #E8C074, #D4A853);
  background-size: 200%;
  border-radius: 2px;
  animation: barLoad 1.2s cubic-bezier(0.4, 0, 0.2, 1) 1.1s forwards,
             barShimmer 0.8s linear 1.1s infinite;
  width: 0%;
}

@keyframes barLoad {
  to { width: 100%; }
}

@keyframes barShimmer {
  to { background-position: -200% 0; }
}

/* Particles */
.pre-particle {
  position: absolute;
  width: 2px;
  height: 2px;
  border-radius: 50%;
  background: #D4A853;
  animation: particleFly linear infinite;
}

@keyframes particleFly {
  0% { opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { opacity: 0; transform: translate(var(--tx), var(--ty)); }
}

html, body {
  height: 100%;
  overflow: hidden;
  font-family: 'Outfit', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 16px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ Grain texture overlay ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  opacity: 0.018;
  pointer-events: none;
  z-index: 0;
}

/* ‚îÄ‚îÄ Ambient light ‚îÄ‚îÄ */
body::after {
  content: '';
  position: fixed;
  top: -20%;
  left: 50%;
  transform: translateX(-50%);
  width: 80vw;
  height: 60vh;
  background: radial-gradient(ellipse, rgba(212,168,83,0.06) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

/* ‚îÄ‚îÄ App Shell ‚îÄ‚îÄ */
.app {
  position: relative;
  z-index: 1;
  height: 100dvh;
  height: 100vh;
  display: flex;
  flex-direction: column;
  max-width: 720px;
  margin: 0 auto;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  background: rgba(12,12,14,0.9);
  backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
  position: relative;
  z-index: 10;
  flex-shrink: 0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 11px;
}

.logo-mark {
  width: 34px;
  height: 34px;
  border-radius: 9px;
  background: linear-gradient(145deg, #2A2318 0%, #1A1710 100%);
  border: 1px solid rgba(212,168,83,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.logo-mark svg {
  width: 18px;
  height: 18px;
  fill: var(--accent);
  position: relative;
  z-index: 1;
}

.logo-mark::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 40% 40%, rgba(212,168,83,0.15) 0%, transparent 60%);
}

.brand {
  display: flex;
  flex-direction: column;
}

.brand-name {
  font-size: 17px;
  font-weight: 700;
  letter-spacing: 0.04em;
  color: var(--text);
}

.brand-sub {
  font-size: 10px;
  font-family: 'IBM Plex Mono', monospace;
  color: var(--text3);
  letter-spacing: 0.08em;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* ‚îÄ‚îÄ Status pill in header ‚îÄ‚îÄ */
.status-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 11px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 99px;
  font-size: 11px;
  font-family: 'IBM Plex Mono', monospace;
  color: var(--text2);
  transition: all 0.3s;
}

.status-pill.live {
  border-color: rgba(92,184,145,0.25);
  background: rgba(92,184,145,0.06);
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
  transition: all 0.3s;
}

.status-dot.on {
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%,100% { opacity:1; }
  50% { opacity:0.5; }
}

/* ‚îÄ‚îÄ Thinking indicator in header (shows while busy) ‚îÄ‚îÄ */
.thinking-pill {
  display: none;
  align-items: center;
  gap: 6px;
  padding: 5px 11px;
  background: var(--accent-bg);
  border: 1px solid rgba(212,168,83,0.2);
  border-radius: 99px;
  font-size: 11px;
  font-family: 'IBM Plex Mono', monospace;
  color: var(--accent);
}

.thinking-pill.show {
  display: flex;
}

.thinking-orbs {
  display: flex;
  gap: 3px;
}

.thinking-orbs span {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--accent);
  animation: orb 1.2s ease-in-out infinite;
}

.thinking-orbs span:nth-child(2) { animation-delay: 0.2s; }
.thinking-orbs span:nth-child(3) { animation-delay: 0.4s; }

@keyframes orb {
  0%,80%,100% { transform: scale(0.6); opacity: 0.4; }
  40% { transform: scale(1); opacity: 1; }
}

/* ‚îÄ‚îÄ Btn ‚îÄ‚îÄ */
.btn-icon {
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 9px;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 15px;
  position: relative;
}

.btn-icon:active {
  transform: scale(0.93);
  background: var(--border2);
}

.btn-icon.active {
  background: var(--accent-bg);
  border-color: rgba(212,168,83,0.3);
  color: var(--accent2);
}

/* ‚îÄ‚îÄ Messages area ‚îÄ‚îÄ */
.messages {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

.messages::-webkit-scrollbar { width: 3px; }
.messages::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
}

/* ‚îÄ‚îÄ Welcome screen ‚îÄ‚îÄ */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 32px 20px 24px;
  gap: 16px;
  animation: fadeUp 0.5s ease-out;
  flex: 1;
}

@keyframes fadeUp {
  from { opacity:0; transform:translateY(16px); }
  to   { opacity:1; transform:translateY(0); }
}

.welcome-glyph {
  width: 64px;
  height: 64px;
  border-radius: 18px;
  background: linear-gradient(145deg, #221C10 0%, #16130A 100%);
  border: 1px solid rgba(212,168,83,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--glow);
  animation: float 4s ease-in-out infinite;
}

.welcome-glyph svg {
  width: 32px;
  height: 32px;
  fill: var(--accent);
}

@keyframes float {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}

.welcome h2 {
  font-size: 26px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text);
}

.welcome p {
  font-size: 14px;
  color: var(--text2);
  line-height: 1.65;
  max-width: 320px;
}

.suggestions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  width: 100%;
  margin-top: 8px;
}

.sug {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 13px 14px;
  cursor: pointer;
  text-align: left;
  color: var(--text2);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  line-height: 1.4;
  transition: all 0.18s;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sug-icon { font-size: 18px; }
.sug-text { font-size: 12px; color: var(--text3); }

.sug:active {
  transform: scale(0.97);
  background: var(--border2);
  border-color: rgba(212,168,83,0.2);
}

/* ‚îÄ‚îÄ Date separator ‚îÄ‚îÄ */
.date-sep {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text3);
  font-size: 11px;
  font-family: 'IBM Plex Mono', monospace;
  letter-spacing: 0.05em;
  margin: 12px 0 4px;
}

.date-sep::before,
.date-sep::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* ‚îÄ‚îÄ Message ‚îÄ‚îÄ */
.msg {
  display: flex;
  gap: 10px;
  animation: msgIn 0.25s ease-out;
  padding: 2px 0;
}

@keyframes msgIn {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}

.msg.user {
  flex-direction: row-reverse;
}

.msg-avatar {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  align-self: flex-end;
  margin-bottom: 2px;
}

.msg.user .msg-avatar {
  background: rgba(255,255,255,0.08);
  border: 1px solid var(--border2);
}

.msg.ai .msg-avatar {
  background: linear-gradient(145deg, #221C10 0%, #181410 100%);
  border: 1px solid rgba(212,168,83,0.2);
}

.msg-body {
  max-width: 80%;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.msg.user .msg-body { align-items: flex-end; }

.msg-bubble {
  padding: 11px 15px;
  border-radius: var(--radius);
  font-size: 15px;
  line-height: 1.6;
  word-wrap: break-word;
  position: relative;
}

.msg.user .msg-bubble {
  background: var(--user-bg);
  border: 1px solid var(--user-border);
  border-bottom-right-radius: 5px;
  color: var(--text);
}

.msg.ai .msg-bubble {
  background: var(--ai-bg);
  border: 1px solid var(--ai-border);
  border-bottom-left-radius: 5px;
  color: var(--text);
}

.msg-bubble code {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12.5px;
  background: rgba(0,0,0,0.35);
  padding: 1px 5px;
  border-radius: 4px;
  color: var(--accent2);
}

.msg-bubble strong { color: var(--accent2); font-weight: 600; }
.msg-bubble a { color: var(--accent2); text-underline-offset: 3px; }

.msg-meta {
  font-size: 10px;
  color: var(--text3);
  font-family: 'IBM Plex Mono', monospace;
  padding: 0 4px;
}

/* ‚îÄ‚îÄ Neural badge ‚îÄ‚îÄ */
.neural-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 6px;
}

.chip {
  display: flex;
  align-items: center;
  gap: 5px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  color: var(--text3);
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  padding: 3px 8px;
  border-radius: 6px;
}

.chip-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ Error bubble ‚îÄ‚îÄ */
.msg-error {
  background: rgba(229,97,90,0.07);
  border: 1px solid rgba(229,97,90,0.2);
  border-radius: var(--radius);
  padding: 11px 15px;
  font-size: 14px;
  color: var(--red);
  max-width: 80%;
  margin-left: 40px;
}

/* ‚îÄ‚îÄ Thinking bubble ‚îÄ‚îÄ */
.thinking-bubble {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px 16px;
  background: var(--ai-bg);
  border: 1px solid var(--ai-border);
  border-radius: var(--radius);
  border-bottom-left-radius: 5px;
  font-size: 13px;
  color: var(--text2);
  max-width: 200px;
}

.thinking-bar {
  display: flex;
  gap: 4px;
}

.thinking-bar span {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--accent);
  animation: orb 1.4s ease-in-out infinite;
}
.thinking-bar span:nth-child(2) { animation-delay: 0.2s; }
.thinking-bar span:nth-child(3) { animation-delay: 0.4s; }

/* ‚îÄ‚îÄ Timer ‚îÄ‚îÄ */
.elapsed {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  color: var(--accent);
  opacity: 0.7;
}

/* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
.input-zone {
  flex-shrink: 0;
  padding: 12px 14px 16px;
  background: rgba(12,12,14,0.92);
  backdrop-filter: blur(24px);
  border-top: 1px solid var(--border);
  padding-bottom: max(16px, env(safe-area-inset-bottom, 16px));
}

.input-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius-lg);
  padding: 6px 6px 6px 14px;
  transition: border-color 0.2s;
}

.input-row:focus-within {
  border-color: rgba(212,168,83,0.3);
  box-shadow: 0 0 0 3px rgba(212,168,83,0.06);
}

.input-row textarea {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  resize: none;
  font-family: inherit;
  font-size: 15px;
  color: var(--text);
  line-height: 1.5;
  padding: 7px 0;
  max-height: 140px;
  overflow-y: auto;
}

.input-row textarea::placeholder { color: var(--text3); }

.input-row textarea::-webkit-scrollbar { width: 0; }

.send-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius);
  background: var(--accent);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}

.send-btn svg {
  width: 18px;
  height: 18px;
  fill: #0C0C0E;
  transform: translateX(1px);
}

.send-btn:active { transform: scale(0.93); }
.send-btn:disabled {
  background: var(--bg3);
  cursor: not-allowed;
}
.send-btn:disabled svg { fill: var(--text3); }

.hint {
  text-align: center;
  font-size: 11px;
  color: var(--text3);
  font-family: 'IBM Plex Mono', monospace;
  margin-top: 8px;
  min-height: 14px;
}

/* ‚îÄ‚îÄ Stats drawer ‚îÄ‚îÄ */
.drawer-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  z-index: 90;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.drawer-overlay.show {
  opacity: 1;
  pointer-events: all;
}

.drawer {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  max-width: 720px;
  margin: 0 auto;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-bottom: none;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  z-index: 100;
  transform: translateY(100%);
  transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
  max-height: 65vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.drawer.open {
  transform: translateY(0);
}

.drawer-handle {
  width: 36px;
  height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 12px auto 0;
  flex-shrink: 0;
}

.drawer-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px 12px;
  flex-shrink: 0;
}

.drawer-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}

.drawer-body {
  overflow-y: auto;
  padding: 0 18px 24px;
  flex: 1;
}

.drawer-body::-webkit-scrollbar { width: 0; }

.section-label {
  font-size: 10px;
  font-family: 'IBM Plex Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text3);
  margin: 16px 0 8px;
}

.stat-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 0;
  border-bottom: 1px solid var(--border);
}

.stat-row:last-child { border-bottom: none; }

.stat-label { font-size: 14px; color: var(--text2); }

.stat-val {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13px;
  font-weight: 500;
  color: var(--accent2);
}

.pbar {
  height: 3px;
  background: var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 2px;
}

.pbar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
  border-radius: 10px;
  transition: width 0.6s ease;
  box-shadow: 0 0 8px rgba(212,168,83,0.4);
}

.llm-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.llm-card.live {
  border-color: rgba(92,184,145,0.25);
  background: rgba(92,184,145,0.04);
}

.llm-card-dot {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
}

.llm-card.live .llm-card-dot {
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  animation: pulse-dot 2s infinite;
}

.llm-card-info h4 {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}

.llm-card-info p {
  font-size: 12px;
  color: var(--text3);
  margin-top: 2px;
}

/* ‚îÄ‚îÄ Busy notice ‚îÄ‚îÄ */
.busy-notice {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  background: var(--accent-bg);
  border: 1px solid rgba(212,168,83,0.15);
  border-radius: var(--radius);
  font-size: 12px;
  color: var(--accent);
  margin-top: 12px;
}

.busy-notice.show { display: flex; }

/* ‚îÄ‚îÄ Ollama banner (debajo del header) ‚îÄ‚îÄ */
.ollama-banner {
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 9px 16px;
  background: rgba(92,184,145,0.06);
  border-bottom: 1px solid rgba(92,184,145,0.15);
  font-size: 12px;
  color: var(--green);
  font-family: 'IBM Plex Mono', monospace;
  flex-shrink: 0;
  animation: fadeUp 0.3s ease-out;
}
.ollama-banner.show { display: flex; }
.ollama-banner-left { display: flex; align-items: center; gap: 8px; }
.ollama-banner-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  animation: pulse-dot 2s infinite;
  flex-shrink: 0;
}
.ollama-banner-btn {
  background: none; border: none;
  color: var(--green); cursor: pointer;
  font-size: 11px; font-family: 'IBM Plex Mono', monospace;
  text-decoration: underline; padding: 0;
  opacity: 0.8;
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ Ollama "no detectado" banner ‚îÄ‚îÄ */
.ollama-offline-banner {
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 9px 16px;
  background: rgba(212,168,83,0.05);
  border-bottom: 1px solid rgba(212,168,83,0.1);
  font-size: 12px;
  color: var(--text3);
  font-family: 'IBM Plex Mono', monospace;
  flex-shrink: 0;
}
.ollama-offline-banner.show { display: flex; }
.ollama-offline-btn {
  background: none; border: 1px solid rgba(212,168,83,0.25);
  color: var(--accent); cursor: pointer;
  font-size: 11px; font-family: 'IBM Plex Mono', monospace;
  padding: 4px 10px; border-radius: 6px;
  white-space: nowrap; flex-shrink: 0;
}

/* ‚îÄ‚îÄ Ollama setup modal ‚îÄ‚îÄ */
.ollama-modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(6px);
  z-index: 200;
  display: none;
  align-items: flex-end;
  justify-content: center;
}
.ollama-modal-overlay.show { display: flex; }

.ollama-modal {
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-bottom: none;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  width: 100%;
  max-width: 720px;
  max-height: 80vh;
  overflow-y: auto;
  padding: 0 0 32px;
  animation: slideUp 0.35s cubic-bezier(0.32,0.72,0,1);
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to   { transform: translateY(0); }
}

.ollama-modal::-webkit-scrollbar { width: 0; }

.ollama-modal-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 12px auto 0;
}

.ollama-modal-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px 0;
}

.ollama-modal-title {
  font-size: 16px; font-weight: 700;
  color: var(--text);
}

.ollama-modal-close {
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text2); cursor: pointer;
  font-size: 14px;
}

.ollama-modal-body {
  padding: 16px 18px 0;
}

.ollama-modal-body p {
  font-size: 13px;
  color: var(--text2);
  line-height: 1.65;
  margin-bottom: 16px;
}

/* tabs */
.ollama-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 16px;
}

.ollama-tab {
  flex: 1;
  padding: 9px 12px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
  text-align: center;
}

.ollama-tab.active {
  background: var(--accent-bg);
  border-color: rgba(212,168,83,0.3);
  color: var(--accent2);
}

.ollama-tab-content { display: none; }
.ollama-tab-content.active { display: block; }

/* steps */
.ollama-steps { display: flex; flex-direction: column; gap: 12px; }

.ollama-step {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

.ollama-step-num {
  width: 26px; height: 26px;
  border-radius: 50%;
  background: var(--accent-bg);
  border: 1px solid rgba(212,168,83,0.25);
  color: var(--accent2);
  font-size: 12px;
  font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  margin-top: 2px;
}

.ollama-step-info h4 {
  font-size: 13px; font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.ollama-step-info p {
  font-size: 12px; color: var(--text2);
  margin-bottom: 0;
  line-height: 1.5;
}

.ollama-code {
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12px;
  color: var(--accent2);
  margin-top: 6px;
  white-space: pre;
  overflow-x: auto;
  position: relative;
}

.ollama-copy-btn {
  position: absolute;
  top: 6px; right: 6px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 5px;
  color: var(--text3);
  font-size: 10px;
  font-family: 'IBM Plex Mono', monospace;
  padding: 2px 7px;
  cursor: pointer;
}

.ollama-note {
  background: rgba(212,168,83,0.05);
  border: 1px solid rgba(212,168,83,0.12);
  border-radius: var(--radius-sm);
  padding: 10px 13px;
  font-size: 12px;
  color: var(--accent);
  margin-top: 16px;
  line-height: 1.6;
}

/* card en el drawer */
.ollama-local-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-top: 8px;
  cursor: pointer;
  transition: all 0.15s;
}
.ollama-local-card:active { opacity: 0.8; }
.ollama-local-card.live {
  border-color: rgba(92,184,145,0.25);
  background: rgba(92,184,145,0.04);
}
.ollama-local-dot {
  width: 9px; height: 9px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
}
.ollama-local-card.live .ollama-local-dot {
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  animation: pulse-dot 2s infinite;
}
.ollama-local-info h4 {
  font-size: 13px; font-weight: 600;
  color: var(--text);
}
.ollama-local-info p {
  font-size: 12px; color: var(--text3);
  margin-top: 2px;
}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (min-width: 720px) {
  .app {
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
  }
}

@media (max-width: 380px) {
  .suggestions { grid-template-columns: 1fr; }
  .msg-body { max-width: 87%; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PRELOADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="preloader">
  <!-- Neural scan lines -->
  <div class="pre-neural">
    <div class="pre-neural-line"></div>
    <div class="pre-neural-line"></div>
    <div class="pre-neural-line"></div>
    <div class="pre-neural-line"></div>
  </div>

  <!-- Corner accents -->
  <div class="pre-corner tl"></div>
  <div class="pre-corner tr"></div>
  <div class="pre-corner bl"></div>
  <div class="pre-corner br"></div>

  <!-- Main letters -->
  <div style="position:relative;z-index:2;display:flex;align-items:flex-end;">
    <div class="pre-letters">
      <span class="pre-letter" data-l="N">N</span>
      <span class="pre-letter" data-l="E">E</span>
      <span class="pre-letter" data-l="X">X</span>
      <span class="pre-letter" data-l="U">U</span>
      <span class="pre-letter" data-l="S">S</span>
    </div>
    <div class="pre-ia">
      <span class="pre-ia-letter">I</span>
      <span class="pre-ia-letter" style="animation-delay:0.95s;">A</span>
    </div>
  </div>

  <div class="pre-tagline">Neural Intelligence System</div>

  <!-- Loading bar -->
  <div class="pre-bar-wrap">
    <div class="pre-bar"></div>
  </div>
</div>

<div class="app">

  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26A7 7 0 0 0 19 9c0-3.87-3.13-7-7-7zm1 15h-2v-1h2v1zm.87-3.87c-.31.19-.87.5-.87 1.87h-2c0-2 1.05-2.59 1.57-2.9.56-.34 1.43-.87.43-1.6-.46-.32-.87-.37-1.22-.35-.66.04-1.28.58-1.56 1.35l-1.84-.76C8.87 8.74 10.35 7.1 12.07 7c.67-.04 1.64.06 2.56.71C16.23 8.75 16 10.38 14.04 11.5c-.2.11-.92.54-1.17.63z"/></svg>
      </div>
      <div class="brand">
        <div class="brand-name">NEXUS</div>
        <div class="brand-sub">v4.0 ¬∑ Neural AI</div>
      </div>
    </div>
    <div class="header-right">
      <div class="thinking-pill" id="thinking-pill">
        <div class="thinking-orbs">
          <span></span><span></span><span></span>
        </div>
        Pensando
      </div>
      <div class="status-pill" id="status-pill">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">...</span>
      </div>
      <button class="btn-icon" id="stats-btn" title="Estad√≠sticas">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h2v18H3V3zm4 7h2v11H7V10zm4-4h2v15h-2V6zm4 8h2v7h-2v-7zm4-6h2v13h-2V8z"/></svg>
      </button>
      <button class="btn-icon" id="new-btn" title="Nueva conversaci√≥n">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
      </button>
    </div>
  </header>

  <!-- Ollama: detectado y activo -->
  <div class="ollama-banner" id="ollama-banner">
    <div class="ollama-banner-left">
      <div class="ollama-banner-dot"></div>
      <span>Ollama local activo ‚Äî potencia extra disponible</span>
    </div>
    <button class="ollama-banner-btn" onclick="closeOllamaBanner()">‚úï</button>
  </div>

  <!-- Ollama: no detectado (solo cuando LLM tambi√©n falla) -->
  <div class="ollama-offline-banner" id="ollama-offline-banner">
    <span>Sin LLM ¬∑ ¬øQuer√©s m√°s poder?</span>
    <button class="ollama-offline-btn" onclick="showOllamaSetup()">Instalar Ollama</button>
  </div>

  <!-- Messages -->
  <div class="messages" id="messages">
    <div class="welcome" id="welcome-screen">
      <div class="welcome-glyph">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26A7 7 0 0 0 19 9c0-3.87-3.13-7-7-7zm1 15h-2v-1h2v1zm.87-3.87c-.31.19-.87.5-.87 1.87h-2c0-2 1.05-2.59 1.57-2.9.56-.34 1.43-.87.43-1.6-.46-.32-.87-.37-1.22-.35-.66.04-1.28.58-1.56 1.35l-1.84-.76C8.87 8.74 10.35 7.1 12.07 7c.67-.04 1.64.06 2.56.71C16.23 8.75 16 10.38 14.04 11.5c-.2.11-.92.54-1.17.63z"/></svg>
      </div>
      <h2>Hola, soy NEXUS</h2>
      <p>Inteligencia artificial con redes neuronales propias y memoria epis√≥dica. Aprendo de cada conversaci√≥n.</p>
      <div class="suggestions">
        <button class="sug" onclick="sendMessage('Hola! ¬øC√≥mo est√°s hoy?')">
          <span class="sug-icon">üëã</span>
          <span>Sal√∫dame</span>
          <span class="sug-text">Empieza a chatear</span>
        </button>
        <button class="sug" onclick="sendMessage('¬øC√≥mo funcionas internamente?')">
          <span class="sug-icon">üî¨</span>
          <span>C√≥mo funciono</span>
          <span class="sug-text">Mi arquitectura neural</span>
        </button>
        <button class="sug" onclick="sendMessage('¬øQui√©n te cre√≥ y cu√°l es tu historia?')">
          <span class="sug-icon">üë§</span>
          <span>Mi creador</span>
          <span class="sug-text">Historia y origen</span>
        </button>
        <button class="sug" onclick="sendMessage('¬øQu√© puedes hacer por m√≠?')">
          <span class="sug-icon">‚ö°</span>
          <span>Capacidades</span>
          <span class="sug-text">Todo lo que puedo hacer</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Input area -->
  <div class="input-zone">
    <div class="input-row">
      <textarea id="input" placeholder="Escribe tu mensaje‚Ä¶" rows="1" onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </div>
    <div class="hint" id="hint">Nexus est√° listo</div>
  </div>

</div>

<!-- Stats drawer backdrop -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeStats()"></div>

<!-- Stats drawer -->
<div class="drawer" id="stats-drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-head">
    <div class="drawer-title">Sistema Neural</div>
    <button class="btn-icon" onclick="closeStats()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </button>
  </div>
  <div class="drawer-body">
    <!-- Busy notice inside drawer -->
    <div class="busy-notice" id="busy-notice">
      <span>‚è≥</span>
      <span>Las estad√≠sticas se actualizar√°n cuando termine de pensar</span>
    </div>

    <div class="section-label">Actividad Neural</div>
    <div class="stat-row">
      <div class="stat-label">Rank Loss</div>
      <div class="stat-val" id="rank-loss">‚Äî</div>
    </div>
    <div class="pbar"><div class="pbar-fill" id="progress" style="width:0%"></div></div>
    <div class="stat-row">
      <div class="stat-label">Intent Loss</div>
      <div class="stat-val" id="intent-loss">‚Äî</div>
    </div>

    <div class="section-label">Memoria</div>
    <div class="stat-row">
      <div class="stat-label">Vocabulario</div>
      <div class="stat-val" id="vocab">‚Äî</div>
    </div>
    <div class="stat-row">
      <div class="stat-label">Episodios</div>
      <div class="stat-val" id="episodes">‚Äî</div>
    </div>
    <div class="stat-row">
      <div class="stat-label">Entrenamientos</div>
      <div class="stat-val" id="trainings">‚Äî</div>
    </div>
    <div class="stat-row">
      <div class="stat-label">Consultas totales</div>
      <div class="stat-val" id="queries">‚Äî</div>
    </div>

    <div class="section-label">Motor de Lenguaje</div>
    <div class="llm-card" id="llm-card">
      <div class="llm-card-dot"></div>
      <div class="llm-card-info">
        <h4 id="llm-name">‚Äî</h4>
        <p id="llm-status">Verificando...</p>
      </div>
    </div>

    <div class="section-label">Ollama Local</div>
    <div class="ollama-local-card" id="ollama-local-card" onclick="showOllamaSetup()">
      <div class="ollama-local-dot" id="ollama-local-dot"></div>
      <div class="ollama-local-info">
        <h4 id="ollama-local-name">Verificando...</h4>
        <p id="ollama-local-status">Toca para ver instrucciones</p>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     OLLAMA SETUP MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="ollama-modal-overlay" id="ollama-modal-overlay" onclick="handleOllamaOverlayClick(event)">
  <div class="ollama-modal" id="ollama-modal">
    <div class="ollama-modal-handle"></div>
    <div class="ollama-modal-head">
      <div class="ollama-modal-title">‚ö° Activar Ollama local</div>
      <button class="ollama-modal-close" onclick="closeOllamaSetup()">‚úï</button>
    </div>
    <div class="ollama-modal-body">
      <p>Con Ollama corriendo en tu dispositivo, NEXUS tiene un motor de lenguaje local de respaldo cuando Groq no est√° disponible. Son solo 3 comandos.</p>

      <div class="ollama-tabs">
        <button class="ollama-tab active" onclick="switchOllamaTab('android', this)">üì± Android (Termux)</button>
        <button class="ollama-tab" onclick="switchOllamaTab('pc', this)">üñ•Ô∏è PC / Mac</button>
      </div>

      <!-- Android tab -->
      <div class="ollama-tab-content active" id="tab-android">
        <div class="ollama-steps">
          <div class="ollama-step">
            <div class="ollama-step-num">1</div>
            <div class="ollama-step-info">
              <h4>Instalar Termux (si no lo ten√©s)</h4>
              <p>Descargalo desde F-Droid o desde tu tienda de apps. Luego abrilo.</p>
            </div>
          </div>
          <div class="ollama-step">
            <div class="ollama-step-num">2</div>
            <div class="ollama-step-info">
              <h4>Instalar y arrancar Ollama</h4>
              <p>Copi√° y peg√° estos comandos en Termux, uno por uno:</p>
              <div class="ollama-code">pkg install ollama<button class="ollama-copy-btn" onclick="copyCode('pkg install ollama')">copiar</button></div>
              <div class="ollama-code" style="margin-top:6px">OLLAMA_ORIGINS="*" ollama serve<button class="ollama-copy-btn" onclick="copyCode('OLLAMA_ORIGINS=&quot;*&quot; ollama serve')">copiar</button></div>
            </div>
          </div>
          <div class="ollama-step">
            <div class="ollama-step-num">3</div>
            <div class="ollama-step-info">
              <h4>Descargar el modelo (en otra ventana de Termux)</h4>
              <p>Abr√≠ una nueva sesi√≥n de Termux (desliz√° desde el borde izquierdo) y ejecut√°:</p>
              <div class="ollama-code">ollama pull llama3.2:1b<button class="ollama-copy-btn" onclick="copyCode('ollama pull llama3.2:1b')">copiar</button></div>
            </div>
          </div>
          <div class="ollama-step">
            <div class="ollama-step-num">4</div>
            <div class="ollama-step-info">
              <h4>Volv√© a esta p√°gina y recargala</h4>
              <p>NEXUS va a detectar Ollama autom√°ticamente y ver√°s el indicador verde.</p>
            </div>
          </div>
        </div>
        <div class="ollama-note">
          ‚ö†Ô∏è El <strong>OLLAMA_ORIGINS="*"</strong> en el paso 2 es clave: permite que la p√°gina web se comunique con Ollama. Sin esto no funciona.
        </div>
      </div>

      <!-- PC tab -->
      <div class="ollama-tab-content" id="tab-pc">
        <div class="ollama-steps">
          <div class="ollama-step">
            <div class="ollama-step-num">1</div>
            <div class="ollama-step-info">
              <h4>Descarg√° e instal√° Ollama</h4>
              <p>Entr√° a <strong>ollama.com</strong>, descarg√° el instalador y segu√≠ los pasos (siguiente, siguiente, instalar).</p>
            </div>
          </div>
          <div class="ollama-step">
            <div class="ollama-step-num">2</div>
            <div class="ollama-step-info">
              <h4>Descarg√° el modelo</h4>
              <div class="ollama-code">ollama pull llama3.2:1b<button class="ollama-copy-btn" onclick="copyCode('ollama pull llama3.2:1b')">copiar</button></div>
              <p style="margin-top:8px">Inici√° Ollama con CORS habilitado:</p>
              <div class="ollama-code">OLLAMA_ORIGINS="*" ollama serve<button class="ollama-copy-btn" onclick="copyCode('OLLAMA_ORIGINS=&quot;*&quot; ollama serve')">copiar</button></div>
              <p style="margin-top:8px;font-size:11px;color:var(--text3)">Windows PowerShell: $env:OLLAMA_ORIGINS="*"; ollama serve</p>
            </div>
          </div>
          <div class="ollama-step">
            <div class="ollama-step-num">3</div>
            <div class="ollama-step-info">
              <h4>Recarg√° esta p√°gina</h4>
              <p>NEXUS detecta Ollama autom√°ticamente. El indicador verde confirma que est√° activo.</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  ESTADO GLOBAL
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  PRELOADER
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
(function() {
  const preloader = document.getElementById('preloader');
  if (!preloader) return;
  const letters = document.querySelectorAll('.pre-letter');

  // Add floating particles
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'pre-particle';
    const x = Math.random() * 100;
    const y = Math.random() * 100;
    const tx = (Math.random() - 0.5) * 300;
    const ty = (Math.random() - 0.5) * 300;
    const dur = 1.5 + Math.random() * 2;
    const delay = Math.random() * 1.5;
    p.style.cssText = `left:${x}%;top:${y}%;--tx:${tx}px;--ty:${ty}px;animation-duration:${dur}s;animation-delay:${delay}s;`;
    preloader.appendChild(p);
  }

  // Pressure compression effect on letters sequentially
  letters.forEach((letter, i) => {
    setTimeout(() => {
      letter.style.animation = 'none';
      letter.offsetHeight; // reflow
      letter.classList.add('compress');
    }, 700 + i * 80);
  });

  // Hide after 2.3s
  setTimeout(() => {
    preloader.classList.add('hide');
    setTimeout(() => preloader.remove(), 700);
  }, 2300);
})();

let busy = false;
let conversationId = null;
let thinkingTimer = null;
let thinkingSeconds = 0;
let statsLoaded = false;

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  OLLAMA LOCAL ‚Äî detecci√≥n y uso desde el frontend
//  Cuando Groq falla, el browser llama directo a
//  localhost:11434 (mismo dispositivo del usuario)
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
const OLLAMA_URL    = 'http://localhost:11434';
const OLLAMA_MODEL  = 'llama3.2:1b';
let   ollamaAvailable = false;
let   ollamaBannerDismissed = false;

async function detectOllama() {
  try {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 2500);
    const r = await fetch(OLLAMA_URL, { signal: ctrl.signal, mode: 'cors' });
    clearTimeout(timer);
    ollamaAvailable = r.ok || r.status === 200;
  } catch (e) {
    ollamaAvailable = false;
  }
  updateOllamaUI();
  return ollamaAvailable;
}

function updateOllamaUI() {
  // Drawer card
  const card   = document.getElementById('ollama-local-card');
  const dot    = document.getElementById('ollama-local-dot');
  const name   = document.getElementById('ollama-local-name');
  const status = document.getElementById('ollama-local-status');

  if (ollamaAvailable) {
    card.classList.add('live');
    dot.style.background  = 'var(--green)';
    dot.style.boxShadow   = '0 0 8px var(--green)';
    name.textContent      = 'Ollama local activo';
    status.textContent    = `Modelo: ${OLLAMA_MODEL}`;

    // Banner verde (si no fue cerrado por el user)
    if (!ollamaBannerDismissed) {
      document.getElementById('ollama-banner').classList.add('show');
    }
    document.getElementById('ollama-offline-banner').classList.remove('show');
  } else {
    card.classList.remove('live');
    dot.style.background  = 'var(--text3)';
    dot.style.boxShadow   = 'none';
    name.textContent      = 'Ollama no detectado';
    status.textContent    = 'Toca para ver c√≥mo instalarlo';
    document.getElementById('ollama-banner').classList.remove('show');
  }
}

function closeOllamaBanner() {
  ollamaBannerDismissed = true;
  document.getElementById('ollama-banner').classList.remove('show');
}

function showOfflineBanner() {
  if (!ollamaAvailable && !ollamaBannerDismissed) {
    document.getElementById('ollama-offline-banner').classList.add('show');
  }
}

// Llama a Ollama DIRECTAMENTE desde el browser (sin pasar por Render)
async function callOllamaLocal(message, history = []) {
  if (!ollamaAvailable) return null;
  try {
    const messages = [
      { role: 'system', content: 'Eres NEXUS, un asistente de inteligencia artificial creado por Jhonatan David Castro Galvis. Responde en espa√±ol de forma concisa y √∫til.' },
      ...history.slice(-6).map(h => ({ role: h.role, content: h.content })),
      { role: 'user', content: message }
    ];

    const r = await fetch(`${OLLAMA_URL}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: OLLAMA_MODEL, messages, stream: false }),
    });

    if (!r.ok) throw new Error(`Ollama HTTP ${r.status}`);
    const data = await r.json();
    return data?.message?.content || null;
  } catch (e) {
    console.warn('[Ollama local] fall√≥:', e.message);
    ollamaAvailable = false;
    updateOllamaUI();
    return null;
  }
}

// Modal helpers
function showOllamaSetup() {
  document.getElementById('ollama-modal-overlay').classList.add('show');
}

function closeOllamaSetup() {
  document.getElementById('ollama-modal-overlay').classList.remove('show');
}

function handleOllamaOverlayClick(e) {
  if (e.target === document.getElementById('ollama-modal-overlay')) {
    closeOllamaSetup();
  }
}

function switchOllamaTab(tab, btn) {
  document.querySelectorAll('.ollama-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.ollama-tab-content').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
}

function copyCode(text) {
  const decoded = text.replace(/&quot;/g, '"').replace(/&amp;/g, '&');
  navigator.clipboard?.writeText(decoded).catch(() => {});
}

// Re-detectar cada 30s mientras la p√°gina est√° abierta
setInterval(detectOllama, 30000);

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  SMART POLLING ‚Äî nunca toca el backend mientras busy
//  Solo un intervalo, pausado cuando Ollama est√° pensando
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
const POLL_INTERVAL = 60000; // 60s ‚Äî suficiente para stats, sin presionar
let pollHandle = null;

function startPolling() {
  if (pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(() => {
    if (!busy) loadStats(false); // silencioso, no fuerza
  }, POLL_INTERVAL);
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  TEXTAREA AUTO-RESIZE
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
const inputEl = document.getElementById('input');
inputEl.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 140) + 'px';
});

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  RENDER MARKDOWN B√ÅSICO
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function renderMd(text) {
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>')
    .replace(/\n/g, '<br>');
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  A√ëADIR MENSAJE
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function addMessage(content, role = 'ai', extras = {}) {
  const welcome = document.getElementById('welcome-screen');
  if (welcome) welcome.remove();

  const msgs = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = `msg ${role}`;

  const userEmoji = 'üßë';
  const aiEmoji = 'üß†';

  if (role === 'user') {
    wrap.innerHTML = `
      <div class="msg-avatar">${userEmoji}</div>
      <div class="msg-body">
        <div class="msg-bubble">${renderMd(content)}</div>
      </div>`;
  } else {
    let chipsHtml = '';
    if (extras.neuralActivity) {
      const a = extras.neuralActivity;
      chipsHtml = `<div class="neural-chips">
        ${a.rank_loss   !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#D4A853"></div>loss ${a.rank_loss.toFixed(4)}</div>` : ''}
        ${a.vocab_size  !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#5CB891"></div>vocab ${a.vocab_size}</div>` : ''}
        ${a.episodes    !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#60A5FA"></div>ep ${a.episodes}</div>` : ''}
        ${a.trainings   !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#A78BFA"></div>train ${a.trainings}</div>` : ''}
      </div>`;
    }
    wrap.innerHTML = `
      <div class="msg-avatar">${aiEmoji}</div>
      <div class="msg-body">
        <div class="msg-bubble">${renderMd(content)}${chipsHtml}</div>
      </div>`;
  }

  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  THINKING INDICATOR + TIMER
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function showThinking() {
  const welcome = document.getElementById('welcome-screen');
  if (welcome) welcome.remove();

  const msgs = document.getElementById('messages');
  const el = document.createElement('div');
  el.id = 'thinking-msg';
  el.className = 'msg ai';
  el.innerHTML = `
    <div class="msg-avatar">üß†</div>
    <div class="msg-body">
      <div class="thinking-bubble">
        <div class="thinking-bar"><span></span><span></span><span></span></div>
        <span>Procesando</span>
        <span class="elapsed" id="elapsed-timer">0s</span>
      </div>
    </div>`;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;

  // Start timer
  thinkingSeconds = 0;
  thinkingTimer = setInterval(() => {
    thinkingSeconds++;
    const el = document.getElementById('elapsed-timer');
    if (el) el.textContent = thinkingSeconds + 's';
  }, 1000);

  // Show header pill
  document.getElementById('thinking-pill').classList.add('show');
}

function hideThinking() {
  const el = document.getElementById('thinking-msg');
  if (el) el.remove();
  clearInterval(thinkingTimer);
  document.getElementById('thinking-pill').classList.remove('show');
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  ERROR
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function addError(msg) {
  const msgs = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'msg-error';
  el.innerHTML = `‚ö†Ô∏è ${msg}`;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  STATUS
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function setStatus(online, text) {
  const dot  = document.getElementById('status-dot');
  const pill = document.getElementById('status-pill');
  const txt  = document.getElementById('status-text');
  if (online) {
    dot.classList.add('on');
    pill.classList.add('live');
  } else {
    dot.classList.remove('on');
    pill.classList.remove('live');
  }
  txt.textContent = text || (online ? 'Online' : 'Offline');
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  SEND MESSAGE
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
async function sendMessage(text) {
  if (busy) return;

  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send-btn');
  const message = text || input.value.trim();
  if (!message) return;

  busy = true;
  input.value = '';
  input.style.height = 'auto';
  sendBtn.disabled = true;
  document.getElementById('hint').textContent = 'NEXUS est√° pensando‚Ä¶';

  addMessage(message, 'user');
  showThinking();

  try {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 90000); // 90s timeout

    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, conversationId }),
      signal: ctrl.signal
    });

    clearTimeout(timer);

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || err.error || `HTTP ${res.status}`);
    }

    const data = await res.json();
    hideThinking();

    conversationId = data.conversationId;

    // ‚îÄ‚îÄ Ollama local fallback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Si el backend respondi√≥ en Smart Mode (sin LLM), intentamos
    // mejorar la respuesta usando Ollama local del usuario
    let finalMessage = data.message || data.response;
    if (!data.llmUsed && ollamaAvailable) {
      try {
        document.getElementById('hint').textContent = 'ü¶ô Usando Ollama local‚Ä¶';
        const ollamaResp = await callOllamaLocal(message);
        if (ollamaResp && ollamaResp.trim().length > 10) {
          finalMessage = ollamaResp;
          data._ollamaUsed = true;
        }
      } catch (e) { /* silencioso */ }
    }
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    addMessage(finalMessage, 'ai', data);

    // Actualizar stats con los datos que ya vienen en la respuesta (sin hacer fetch extra)
    if (data.neuralActivity || data.neural_activity) {
      updateStats(data.neuralActivity || data.neural_activity);
    }

    setStatus(true, 'Cerebro activo');
    document.getElementById('hint').textContent = 'Nexus est√° listo ¬∑ Enter para enviar';

  } catch (err) {
    hideThinking();
    if (err.name === 'AbortError') {
      addError('Tiempo de espera agotado. El cerebro sigue procesando. Intenta de nuevo.');
    } else {
      addError(err.message);
    }
    setStatus(false, 'Error ‚Äî reintentando');
    document.getElementById('hint').textContent = '';
  }

  busy = false;
  sendBtn.disabled = false;
  input.focus();
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  STATS ‚Äî LOAD (solo si NO busy)
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
async function loadStats(forced = false) {
  // La regla de oro: si el brain est√° ocupado con Ollama, NO hacemos fetch
  if (busy && !forced) {
    // Muestra aviso en el drawer si est√° abierto
    document.getElementById('busy-notice').classList.add('show');
    return;
  }
  document.getElementById('busy-notice').classList.remove('show');

  try {
    const res = await fetch('/api/stats');
    if (!res.ok) return;
    const data = await res.json();
    const neural = data.neural || {};
    updateStats(neural);
    setStatus(true, 'Cerebro activo');
    statsLoaded = true;
  } catch (e) {
    console.warn('[stats] fetch silenciado:', e.message);
    setStatus(false, 'Desconectado');
  }
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  STATS ‚Äî UPDATE DOM
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function updateStats(d) {
  if (!d) return;
  if (d.rank_loss !== undefined) {
    document.getElementById('rank-loss').textContent = d.rank_loss.toFixed?.(5) || d.rank_loss;
    document.getElementById('progress').style.width = Math.max(5, Math.min(95, (1 - d.rank_loss) * 100)) + '%';
  }
  if (d.intent_loss !== undefined)
    document.getElementById('intent-loss').textContent = d.intent_loss.toFixed?.(5) || d.intent_loss;
  if (d.vocab_size  !== undefined)
    document.getElementById('vocab').textContent = d.vocab_size;
  if (d.episodes    !== undefined)
    document.getElementById('episodes').textContent = d.episodes;
  if (d.trainings   !== undefined)
    document.getElementById('trainings').textContent = d.trainings;
  if (d.queries     !== undefined) {
    document.getElementById('queries').textContent = d.queries;
    document.getElementById('hint').textContent = `${d.queries} consultas ¬∑ ${d.trainings || 0} entrenamientos`;
  }
  if (d.llm_available !== undefined)
    updateLLM(d.llm_available, d.llm_model);
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  LLM BADGE
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function updateLLM(available, model) {
  const card   = document.getElementById('llm-card');
  const name   = document.getElementById('llm-name');
  const status = document.getElementById('llm-status');
  if (available) {
    card.classList.add('live');
    name.textContent   = model || 'LLM activo';
    status.textContent = 'Motor de lenguaje conectado';
  } else {
    card.classList.remove('live');
    name.textContent   = 'LLM desconectado';
    status.textContent = 'Configura Groq u Ollama';
    showOfflineBanner();
  }
}

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  STATS DRAWER
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
function openStats() {
  document.getElementById('stats-drawer').classList.add('open');
  document.getElementById('drawer-overlay').classList.add('show');
  document.getElementById('stats-btn').classList.add('active');
  // Solo carga si no est√° busy y a√∫n no lo ha cargado
  if (!busy) loadStats();
  else document.getElementById('busy-notice').classList.add('show');
}

function closeStats() {
  document.getElementById('stats-drawer').classList.remove('open');
  document.getElementById('drawer-overlay').classList.remove('show');
  document.getElementById('stats-btn').classList.remove('active');
  document.getElementById('busy-notice').classList.remove('show');
}

document.getElementById('stats-btn').addEventListener('click', () => {
  const isOpen = document.getElementById('stats-drawer').classList.contains('open');
  isOpen ? closeStats() : openStats();
});

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  NUEVO CHAT
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
document.getElementById('new-btn').addEventListener('click', () => {
  conversationId = null;
  const msgs = document.getElementById('messages');
  msgs.innerHTML = `
    <div class="welcome" id="welcome-screen">
      <div class="welcome-glyph">
        <svg viewBox="0 0 24 24" fill="var(--accent)"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26A7 7 0 0 0 19 9c0-3.87-3.13-7-7-7zm1 15h-2v-1h2v1zm.87-3.87c-.31.19-.87.5-.87 1.87h-2c0-2 1.05-2.59 1.57-2.9.56-.34 1.43-.87.43-1.6-.46-.32-.87-.37-1.22-.35-.66.04-1.28.58-1.56 1.35l-1.84-.76C8.87 8.74 10.35 7.1 12.07 7c.67-.04 1.64.06 2.56.71C16.23 8.75 16 10.38 14.04 11.5c-.2.11-.92.54-1.17.63z"/></svg>
      </div>
      <h2>Hola, soy NEXUS</h2>
      <p>Inteligencia artificial con redes neuronales propias y memoria epis√≥dica. Aprendo de cada conversaci√≥n.</p>
      <div class="suggestions">
        <button class="sug" onclick="sendMessage('Hola! ¬øC√≥mo est√°s hoy?')">
          <span class="sug-icon">üëã</span><span>Sal√∫dame</span>
          <span class="sug-text">Empieza a chatear</span>
        </button>
        <button class="sug" onclick="sendMessage('¬øC√≥mo funcionas internamente?')">
          <span class="sug-icon">üî¨</span><span>C√≥mo funciono</span>
          <span class="sug-text">Mi arquitectura neural</span>
        </button>
        <button class="sug" onclick="sendMessage('¬øQui√©n te cre√≥ y cu√°l es tu historia?')">
          <span class="sug-icon">üë§</span><span>Mi creador</span>
          <span class="sug-text">Historia y origen</span>
        </button>
        <button class="sug" onclick="sendMessage('¬øQu√© puedes hacer por m√≠?')">
          <span class="sug-icon">‚ö°</span><span>Capacidades</span>
          <span class="sug-text">Todo lo que puedo hacer</span>
        </button>
      </div>
    </div>`;
  document.getElementById('hint').textContent = 'Nexus est√° listo';
});

// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
//  INIT
// ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
loadStats();       // carga inicial (no hay busy al cargar)
startPolling();    // polling lento que se pausa autom√°ticamente si busy
detectOllama();    // detectar Ollama local al arrancar
inputEl.focus();
</script>

</body>
</html>
