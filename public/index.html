<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEXUS â€” Neural Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after {
  margin: 0; padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --bg:        #0C0C0E;
  --bg2:       #141417;
  --bg3:       #1C1C21;
  --surface:   rgba(28, 28, 33, 0.85);
  --border:    rgba(255,255,255,0.07);
  --border2:   rgba(255,255,255,0.12);
  --text:      #F0EEE8;
  --text2:     #A8A49C;
  --text3:     #5C5954;
  --accent:    #D4A853;       /* amber warm */
  --accent2:   #E8C074;
  --accent-bg: rgba(212,168,83,0.08);
  --user-bg:   rgba(255,255,255,0.06);
  --user-border:rgba(255,255,255,0.1);
  --ai-bg:     rgba(212,168,83,0.05);
  --ai-border: rgba(212,168,83,0.15);
  --green:     #5CB891;
  --red:       #E5615A;
  --radius-sm: 10px;
  --radius:    16px;
  --radius-lg: 22px;
  --shadow:    0 8px 32px rgba(0,0,0,0.5);
  --glow:      0 0 24px rgba(212,168,83,0.2);
}

html, body {
  height: 100%;
  overflow: hidden;
  font-family: 'Outfit', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  font-size: 16px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ Grain texture overlay â”€â”€ */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  opacity: 0.018;
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ Ambient light â”€â”€ */
body::after {
  content: '';
  position: fixed;
  top: -20%;
  left: 50%;
  transform: translateX(-50%);
  width: 80vw;
  height: 60vh;
  background: radial-gradient(ellipse, rgba(212,168,83,0.06) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ App Shell â”€â”€ */
.app {
  position: relative;
  z-index: 1;
  height: 100dvh;
  height: 100vh;
  display: flex;
  flex-direction: column;
  max-width: 720px;
  margin: 0 auto;
}

/* â”€â”€ Header â”€â”€ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px;
  background: rgba(12,12,14,0.9);
  backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--border);
  position: relative;
  z-index: 10;
  flex-shrink: 0;
}

.logo {
  display: flex;
  align-items: center;
  gap: 11px;
}

.logo-mark {
  width: 34px;
  height: 34px;
  border-radius: 9px;
  background: linear-gradient(145deg, #2A2318 0%, #1A1710 100%);
  border: 1px solid rgba(212,168,83,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.logo-mark svg {
  width: 18px;
  height: 18px;
  fill: var(--accent);
  position: relative;
  z-index: 1;
}

.logo-mark::after {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 40% 40%, rgba(212,168,83,0.15) 0%, transparent 60%);
}

.brand {
  display: flex;
  flex-direction: column;
}

.brand-name {
  font-size: 17px;
  font-weight: 700;
  letter-spacing: 0.04em;
  color: var(--text);
}

.brand-sub {
  font-size: 10px;
  font-family: 'IBM Plex Mono', monospace;
  color: var(--text3);
  letter-spacing: 0.08em;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* â”€â”€ Status pill in header â”€â”€ */
.status-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 5px 11px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 99px;
  font-size: 11px;
  font-family: 'IBM Plex Mono', monospace;
  color: var(--text2);
  transition: all 0.3s;
}

.status-pill.live {
  border-color: rgba(92,184,145,0.25);
  background: rgba(92,184,145,0.06);
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
  transition: all 0.3s;
}

.status-dot.on {
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%,100% { opacity:1; }
  50% { opacity:0.5; }
}

/* â”€â”€ Thinking indicator in header (shows while busy) â”€â”€ */
.thinking-pill {
  display: none;
  align-items: center;
  gap: 6px;
  padding: 5px 11px;
  background: var(--accent-bg);
  border: 1px solid rgba(212,168,83,0.2);
  border-radius: 99px;
  font-size: 11px;
  font-family: 'IBM Plex Mono', monospace;
  color: var(--accent);
}

.thinking-pill.show {
  display: flex;
}

.thinking-orbs {
  display: flex;
  gap: 3px;
}

.thinking-orbs span {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: var(--accent);
  animation: orb 1.2s ease-in-out infinite;
}

.thinking-orbs span:nth-child(2) { animation-delay: 0.2s; }
.thinking-orbs span:nth-child(3) { animation-delay: 0.4s; }

@keyframes orb {
  0%,80%,100% { transform: scale(0.6); opacity: 0.4; }
  40% { transform: scale(1); opacity: 1; }
}

/* â”€â”€ Btn â”€â”€ */
.btn-icon {
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 9px;
  color: var(--text2);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 15px;
  position: relative;
}

.btn-icon:active {
  transform: scale(0.93);
  background: var(--border2);
}

.btn-icon.active {
  background: var(--accent-bg);
  border-color: rgba(212,168,83,0.3);
  color: var(--accent2);
}

/* â”€â”€ Messages area â”€â”€ */
.messages {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

.messages::-webkit-scrollbar { width: 3px; }
.messages::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
}

/* â”€â”€ Welcome screen â”€â”€ */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 32px 20px 24px;
  gap: 16px;
  animation: fadeUp 0.5s ease-out;
  flex: 1;
}

@keyframes fadeUp {
  from { opacity:0; transform:translateY(16px); }
  to   { opacity:1; transform:translateY(0); }
}

.welcome-glyph {
  width: 64px;
  height: 64px;
  border-radius: 18px;
  background: linear-gradient(145deg, #221C10 0%, #16130A 100%);
  border: 1px solid rgba(212,168,83,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--glow);
  animation: float 4s ease-in-out infinite;
}

.welcome-glyph svg {
  width: 32px;
  height: 32px;
  fill: var(--accent);
}

@keyframes float {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-6px); }
}

.welcome h2 {
  font-size: 26px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text);
}

.welcome p {
  font-size: 14px;
  color: var(--text2);
  line-height: 1.65;
  max-width: 320px;
}

.suggestions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  width: 100%;
  margin-top: 8px;
}

.sug {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 13px 14px;
  cursor: pointer;
  text-align: left;
  color: var(--text2);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  line-height: 1.4;
  transition: all 0.18s;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sug-icon { font-size: 18px; }
.sug-text { font-size: 12px; color: var(--text3); }

.sug:active {
  transform: scale(0.97);
  background: var(--border2);
  border-color: rgba(212,168,83,0.2);
}

/* â”€â”€ Date separator â”€â”€ */
.date-sep {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text3);
  font-size: 11px;
  font-family: 'IBM Plex Mono', monospace;
  letter-spacing: 0.05em;
  margin: 12px 0 4px;
}

.date-sep::before,
.date-sep::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* â”€â”€ Message â”€â”€ */
.msg {
  display: flex;
  gap: 10px;
  animation: msgIn 0.25s ease-out;
  padding: 2px 0;
}

@keyframes msgIn {
  from { opacity:0; transform:translateY(8px); }
  to   { opacity:1; transform:translateY(0); }
}

.msg.user {
  flex-direction: row-reverse;
}

.msg-avatar {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  align-self: flex-end;
  margin-bottom: 2px;
}

.msg.user .msg-avatar {
  background: rgba(255,255,255,0.08);
  border: 1px solid var(--border2);
}

.msg.ai .msg-avatar {
  background: linear-gradient(145deg, #221C10 0%, #181410 100%);
  border: 1px solid rgba(212,168,83,0.2);
}

.msg-body {
  max-width: 80%;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.msg.user .msg-body { align-items: flex-end; }

.msg-bubble {
  padding: 11px 15px;
  border-radius: var(--radius);
  font-size: 15px;
  line-height: 1.6;
  word-wrap: break-word;
  position: relative;
}

.msg.user .msg-bubble {
  background: var(--user-bg);
  border: 1px solid var(--user-border);
  border-bottom-right-radius: 5px;
  color: var(--text);
}

.msg.ai .msg-bubble {
  background: var(--ai-bg);
  border: 1px solid var(--ai-border);
  border-bottom-left-radius: 5px;
  color: var(--text);
}

.msg-bubble code {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 12.5px;
  background: rgba(0,0,0,0.35);
  padding: 1px 5px;
  border-radius: 4px;
  color: var(--accent2);
}

.msg-bubble strong { color: var(--accent2); font-weight: 600; }
.msg-bubble a { color: var(--accent2); text-underline-offset: 3px; }

.msg-meta {
  font-size: 10px;
  color: var(--text3);
  font-family: 'IBM Plex Mono', monospace;
  padding: 0 4px;
}

/* â”€â”€ Neural badge â”€â”€ */
.neural-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 6px;
}

.chip {
  display: flex;
  align-items: center;
  gap: 5px;
  font-family: 'IBM Plex Mono', monospace;
  font-size: 10px;
  color: var(--text3);
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--border);
  padding: 3px 8px;
  border-radius: 6px;
}

.chip-dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* â”€â”€ Error bubble â”€â”€ */
.msg-error {
  background: rgba(229,97,90,0.07);
  border: 1px solid rgba(229,97,90,0.2);
  border-radius: var(--radius);
  padding: 11px 15px;
  font-size: 14px;
  color: var(--red);
  max-width: 80%;
  margin-left: 40px;
}

/* â”€â”€ Thinking bubble â”€â”€ */
.thinking-bubble {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px 16px;
  background: var(--ai-bg);
  border: 1px solid var(--ai-border);
  border-radius: var(--radius);
  border-bottom-left-radius: 5px;
  font-size: 13px;
  color: var(--text2);
  max-width: 200px;
}

.thinking-bar {
  display: flex;
  gap: 4px;
}

.thinking-bar span {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--accent);
  animation: orb 1.4s ease-in-out infinite;
}
.thinking-bar span:nth-child(2) { animation-delay: 0.2s; }
.thinking-bar span:nth-child(3) { animation-delay: 0.4s; }

/* â”€â”€ Timer â”€â”€ */
.elapsed {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 11px;
  color: var(--accent);
  opacity: 0.7;
}

/* â”€â”€ Input area â”€â”€ */
.input-zone {
  flex-shrink: 0;
  padding: 12px 14px 16px;
  background: rgba(12,12,14,0.92);
  backdrop-filter: blur(24px);
  border-top: 1px solid var(--border);
  padding-bottom: max(16px, env(safe-area-inset-bottom, 16px));
}

.input-row {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  background: var(--bg3);
  border: 1px solid var(--border2);
  border-radius: var(--radius-lg);
  padding: 6px 6px 6px 14px;
  transition: border-color 0.2s;
}

.input-row:focus-within {
  border-color: rgba(212,168,83,0.3);
  box-shadow: 0 0 0 3px rgba(212,168,83,0.06);
}

.input-row textarea {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  resize: none;
  font-family: inherit;
  font-size: 15px;
  color: var(--text);
  line-height: 1.5;
  padding: 7px 0;
  max-height: 140px;
  overflow-y: auto;
}

.input-row textarea::placeholder { color: var(--text3); }

.input-row textarea::-webkit-scrollbar { width: 0; }

.send-btn {
  width: 40px;
  height: 40px;
  border-radius: var(--radius);
  background: var(--accent);
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}

.send-btn svg {
  width: 18px;
  height: 18px;
  fill: #0C0C0E;
  transform: translateX(1px);
}

.send-btn:active { transform: scale(0.93); }
.send-btn:disabled {
  background: var(--bg3);
  cursor: not-allowed;
}
.send-btn:disabled svg { fill: var(--text3); }

.hint {
  text-align: center;
  font-size: 11px;
  color: var(--text3);
  font-family: 'IBM Plex Mono', monospace;
  margin-top: 8px;
  min-height: 14px;
}

/* â”€â”€ Stats drawer â”€â”€ */
.drawer-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  z-index: 90;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.drawer-overlay.show {
  opacity: 1;
  pointer-events: all;
}

.drawer {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  max-width: 720px;
  margin: 0 auto;
  background: var(--bg2);
  border: 1px solid var(--border2);
  border-bottom: none;
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  z-index: 100;
  transform: translateY(100%);
  transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
  max-height: 65vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.drawer.open {
  transform: translateY(0);
}

.drawer-handle {
  width: 36px;
  height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 12px auto 0;
  flex-shrink: 0;
}

.drawer-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 18px 12px;
  flex-shrink: 0;
}

.drawer-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}

.drawer-body {
  overflow-y: auto;
  padding: 0 18px 24px;
  flex: 1;
}

.drawer-body::-webkit-scrollbar { width: 0; }

.section-label {
  font-size: 10px;
  font-family: 'IBM Plex Mono', monospace;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text3);
  margin: 16px 0 8px;
}

.stat-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 11px 0;
  border-bottom: 1px solid var(--border);
}

.stat-row:last-child { border-bottom: none; }

.stat-label { font-size: 14px; color: var(--text2); }

.stat-val {
  font-family: 'IBM Plex Mono', monospace;
  font-size: 13px;
  font-weight: 500;
  color: var(--accent2);
}

.pbar {
  height: 3px;
  background: var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-top: 2px;
}

.pbar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
  border-radius: 10px;
  transition: width 0.6s ease;
  box-shadow: 0 0 8px rgba(212,168,83,0.4);
}

.llm-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.llm-card.live {
  border-color: rgba(92,184,145,0.25);
  background: rgba(92,184,145,0.04);
}

.llm-card-dot {
  width: 9px;
  height: 9px;
  border-radius: 50%;
  background: var(--text3);
  flex-shrink: 0;
}

.llm-card.live .llm-card-dot {
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
  animation: pulse-dot 2s infinite;
}

.llm-card-info h4 {
  font-size: 13px;
  font-weight: 600;
  color: var(--text);
}

.llm-card-info p {
  font-size: 12px;
  color: var(--text3);
  margin-top: 2px;
}

/* â”€â”€ Busy notice â”€â”€ */
.busy-notice {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  background: var(--accent-bg);
  border: 1px solid rgba(212,168,83,0.15);
  border-radius: var(--radius);
  font-size: 12px;
  color: var(--accent);
  margin-top: 12px;
}

.busy-notice.show { display: flex; }

/* â”€â”€ Responsive â”€â”€ */
@media (min-width: 720px) {
  .app {
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
  }
}

@media (max-width: 380px) {
  .suggestions { grid-template-columns: 1fr; }
  .msg-body { max-width: 87%; }
}
</style>
</head>
<body>

<div class="app">

  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26A7 7 0 0 0 19 9c0-3.87-3.13-7-7-7zm1 15h-2v-1h2v1zm.87-3.87c-.31.19-.87.5-.87 1.87h-2c0-2 1.05-2.59 1.57-2.9.56-.34 1.43-.87.43-1.6-.46-.32-.87-.37-1.22-.35-.66.04-1.28.58-1.56 1.35l-1.84-.76C8.87 8.74 10.35 7.1 12.07 7c.67-.04 1.64.06 2.56.71C16.23 8.75 16 10.38 14.04 11.5c-.2.11-.92.54-1.17.63z"/></svg>
      </div>
      <div class="brand">
        <div class="brand-name">NEXUS</div>
        <div class="brand-sub">v4.0 Â· Neural AI</div>
      </div>
    </div>
    <div class="header-right">
      <div class="thinking-pill" id="thinking-pill">
        <div class="thinking-orbs">
          <span></span><span></span><span></span>
        </div>
        Pensando
      </div>
      <div class="status-pill" id="status-pill">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">...</span>
      </div>
      <button class="btn-icon" id="stats-btn" title="EstadÃ­sticas">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3h2v18H3V3zm4 7h2v11H7V10zm4-4h2v15h-2V6zm4 8h2v7h-2v-7zm4-6h2v13h-2V8z"/></svg>
      </button>
      <button class="btn-icon" id="new-btn" title="Nueva conversaciÃ³n">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor"><path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6z"/></svg>
      </button>
    </div>
  </header>

  <!-- Messages -->
  <div class="messages" id="messages">
    <div class="welcome" id="welcome-screen">
      <div class="welcome-glyph">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26A7 7 0 0 0 19 9c0-3.87-3.13-7-7-7zm1 15h-2v-1h2v1zm.87-3.87c-.31.19-.87.5-.87 1.87h-2c0-2 1.05-2.59 1.57-2.9.56-.34 1.43-.87.43-1.6-.46-.32-.87-.37-1.22-.35-.66.04-1.28.58-1.56 1.35l-1.84-.76C8.87 8.74 10.35 7.1 12.07 7c.67-.04 1.64.06 2.56.71C16.23 8.75 16 10.38 14.04 11.5c-.2.11-.92.54-1.17.63z"/></svg>
      </div>
      <h2>Hola, soy NEXUS</h2>
      <p>Inteligencia artificial con redes neuronales propias y memoria episÃ³dica. Aprendo de cada conversaciÃ³n.</p>
      <div class="suggestions">
        <button class="sug" onclick="sendMessage('Hola! Â¿CÃ³mo estÃ¡s hoy?')">
          <span class="sug-icon">ğŸ‘‹</span>
          <span>SalÃºdame</span>
          <span class="sug-text">Empieza a chatear</span>
        </button>
        <button class="sug" onclick="sendMessage('Â¿CÃ³mo funcionas internamente?')">
          <span class="sug-icon">ğŸ”¬</span>
          <span>CÃ³mo funciono</span>
          <span class="sug-text">Mi arquitectura neural</span>
        </button>
        <button class="sug" onclick="sendMessage('Â¿QuiÃ©n te creÃ³ y cuÃ¡l es tu historia?')">
          <span class="sug-icon">ğŸ‘¤</span>
          <span>Mi creador</span>
          <span class="sug-text">Historia y origen</span>
        </button>
        <button class="sug" onclick="sendMessage('Â¿QuÃ© puedes hacer por mÃ­?')">
          <span class="sug-icon">âš¡</span>
          <span>Capacidades</span>
          <span class="sug-text">Todo lo que puedo hacer</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Input area -->
  <div class="input-zone">
    <div class="input-row">
      <textarea id="input" placeholder="Escribe tu mensajeâ€¦" rows="1" onkeydown="handleKey(event)"></textarea>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">
        <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
      </button>
    </div>
    <div class="hint" id="hint">Nexus estÃ¡ listo</div>
  </div>

</div>

<!-- Stats drawer backdrop -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeStats()"></div>

<!-- Stats drawer -->
<div class="drawer" id="stats-drawer">
  <div class="drawer-handle"></div>
  <div class="drawer-head">
    <div class="drawer-title">Sistema Neural</div>
    <button class="btn-icon" onclick="closeStats()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
    </button>
  </div>
  <div class="drawer-body">
    <!-- Busy notice inside drawer -->
    <div class="busy-notice" id="busy-notice">
      <span>â³</span>
      <span>Las estadÃ­sticas se actualizarÃ¡n cuando termine de pensar</span>
    </div>

    <div class="section-label">Actividad Neural</div>
    <div class="stat-row">
      <div class="stat-label">Rank Loss</div>
      <div class="stat-val" id="rank-loss">â€”</div>
    </div>
    <div class="pbar"><div class="pbar-fill" id="progress" style="width:0%"></div></div>
    <div class="stat-row">
      <div class="stat-label">Intent Loss</div>
      <div class="stat-val" id="intent-loss">â€”</div>
    </div>

    <div class="section-label">Memoria</div>
    <div class="stat-row">
      <div class="stat-label">Vocabulario</div>
      <div class="stat-val" id="vocab">â€”</div>
    </div>
    <div class="stat-row">
      <div class="stat-label">Episodios</div>
      <div class="stat-val" id="episodes">â€”</div>
    </div>
    <div class="stat-row">
      <div class="stat-label">Entrenamientos</div>
      <div class="stat-val" id="trainings">â€”</div>
    </div>
    <div class="stat-row">
      <div class="stat-label">Consultas totales</div>
      <div class="stat-val" id="queries">â€”</div>
    </div>

    <div class="section-label">Motor de Lenguaje</div>
    <div class="llm-card" id="llm-card">
      <div class="llm-card-dot"></div>
      <div class="llm-card-info">
        <h4 id="llm-name">â€”</h4>
        <p id="llm-status">Verificando...</p>
      </div>
    </div>
  </div>
</div>

<script>
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  ESTADO GLOBAL
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
let busy = false;
let conversationId = null;
let thinkingTimer = null;
let thinkingSeconds = 0;
let statsLoaded = false;

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  SMART POLLING â€” nunca toca el backend mientras busy
//  Solo un intervalo, pausado cuando Ollama estÃ¡ pensando
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const POLL_INTERVAL = 60000; // 60s â€” suficiente para stats, sin presionar
let pollHandle = null;

function startPolling() {
  if (pollHandle) clearInterval(pollHandle);
  pollHandle = setInterval(() => {
    if (!busy) loadStats(false); // silencioso, no fuerza
  }, POLL_INTERVAL);
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  TEXTAREA AUTO-RESIZE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const inputEl = document.getElementById('input');
inputEl.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 140) + 'px';
});

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  RENDER MARKDOWN BÃSICO
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function renderMd(text) {
  return text
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>')
    .replace(/\n/g, '<br>');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  AÃ‘ADIR MENSAJE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function addMessage(content, role = 'ai', extras = {}) {
  const welcome = document.getElementById('welcome-screen');
  if (welcome) welcome.remove();

  const msgs = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.className = `msg ${role}`;

  const userEmoji = 'ğŸ§‘';
  const aiEmoji = 'ğŸ§ ';

  if (role === 'user') {
    wrap.innerHTML = `
      <div class="msg-avatar">${userEmoji}</div>
      <div class="msg-body">
        <div class="msg-bubble">${renderMd(content)}</div>
      </div>`;
  } else {
    let chipsHtml = '';
    if (extras.neuralActivity) {
      const a = extras.neuralActivity;
      chipsHtml = `<div class="neural-chips">
        ${a.rank_loss   !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#D4A853"></div>loss ${a.rank_loss.toFixed(4)}</div>` : ''}
        ${a.vocab_size  !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#5CB891"></div>vocab ${a.vocab_size}</div>` : ''}
        ${a.episodes    !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#60A5FA"></div>ep ${a.episodes}</div>` : ''}
        ${a.trainings   !== undefined ? `<div class="chip"><div class="chip-dot" style="background:#A78BFA"></div>train ${a.trainings}</div>` : ''}
      </div>`;
    }
    wrap.innerHTML = `
      <div class="msg-avatar">${aiEmoji}</div>
      <div class="msg-body">
        <div class="msg-bubble">${renderMd(content)}${chipsHtml}</div>
      </div>`;
  }

  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  THINKING INDICATOR + TIMER
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function showThinking() {
  const welcome = document.getElementById('welcome-screen');
  if (welcome) welcome.remove();

  const msgs = document.getElementById('messages');
  const el = document.createElement('div');
  el.id = 'thinking-msg';
  el.className = 'msg ai';
  el.innerHTML = `
    <div class="msg-avatar">ğŸ§ </div>
    <div class="msg-body">
      <div class="thinking-bubble">
        <div class="thinking-bar"><span></span><span></span><span></span></div>
        <span>Procesando</span>
        <span class="elapsed" id="elapsed-timer">0s</span>
      </div>
    </div>`;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;

  // Start timer
  thinkingSeconds = 0;
  thinkingTimer = setInterval(() => {
    thinkingSeconds++;
    const el = document.getElementById('elapsed-timer');
    if (el) el.textContent = thinkingSeconds + 's';
  }, 1000);

  // Show header pill
  document.getElementById('thinking-pill').classList.add('show');
}

function hideThinking() {
  const el = document.getElementById('thinking-msg');
  if (el) el.remove();
  clearInterval(thinkingTimer);
  document.getElementById('thinking-pill').classList.remove('show');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  ERROR
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function addError(msg) {
  const msgs = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'msg-error';
  el.innerHTML = `âš ï¸ ${msg}`;
  msgs.appendChild(el);
  msgs.scrollTop = msgs.scrollHeight;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  STATUS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function setStatus(online, text) {
  const dot  = document.getElementById('status-dot');
  const pill = document.getElementById('status-pill');
  const txt  = document.getElementById('status-text');
  if (online) {
    dot.classList.add('on');
    pill.classList.add('live');
  } else {
    dot.classList.remove('on');
    pill.classList.remove('live');
  }
  txt.textContent = text || (online ? 'Online' : 'Offline');
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  SEND MESSAGE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
async function sendMessage(text) {
  if (busy) return;

  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send-btn');
  const message = text || input.value.trim();
  if (!message) return;

  busy = true;
  input.value = '';
  input.style.height = 'auto';
  sendBtn.disabled = true;
  document.getElementById('hint').textContent = 'NEXUS estÃ¡ pensandoâ€¦';

  addMessage(message, 'user');
  showThinking();

  try {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), 90000); // 90s timeout

    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, conversationId }),
      signal: ctrl.signal
    });

    clearTimeout(timer);

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || err.error || `HTTP ${res.status}`);
    }

    const data = await res.json();
    hideThinking();

    conversationId = data.conversationId;
    addMessage(data.message || data.response, 'ai', data);

    // Actualizar stats con los datos que ya vienen en la respuesta (sin hacer fetch extra)
    if (data.neuralActivity || data.neural_activity) {
      updateStats(data.neuralActivity || data.neural_activity);
    }

    setStatus(true, 'Cerebro activo');
    document.getElementById('hint').textContent = 'Nexus estÃ¡ listo Â· Enter para enviar';

  } catch (err) {
    hideThinking();
    if (err.name === 'AbortError') {
      addError('Tiempo de espera agotado. El cerebro sigue procesando. Intenta de nuevo.');
    } else {
      addError(err.message);
    }
    setStatus(false, 'Error â€” reintentando');
    document.getElementById('hint').textContent = '';
  }

  busy = false;
  sendBtn.disabled = false;
  input.focus();
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  STATS â€” LOAD (solo si NO busy)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
async function loadStats(forced = false) {
  // La regla de oro: si el brain estÃ¡ ocupado con Ollama, NO hacemos fetch
  if (busy && !forced) {
    // Muestra aviso en el drawer si estÃ¡ abierto
    document.getElementById('busy-notice').classList.add('show');
    return;
  }
  document.getElementById('busy-notice').classList.remove('show');

  try {
    const res = await fetch('/api/stats');
    if (!res.ok) return;
    const data = await res.json();
    const neural = data.neural || {};
    updateStats(neural);
    setStatus(true, 'Cerebro activo');
    statsLoaded = true;
  } catch (e) {
    console.warn('[stats] fetch silenciado:', e.message);
    setStatus(false, 'Desconectado');
  }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  STATS â€” UPDATE DOM
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function updateStats(d) {
  if (!d) return;
  if (d.rank_loss !== undefined) {
    document.getElementById('rank-loss').textContent = d.rank_loss.toFixed?.(5) || d.rank_loss;
    document.getElementById('progress').style.width = Math.max(5, Math.min(95, (1 - d.rank_loss) * 100)) + '%';
  }
  if (d.intent_loss !== undefined)
    document.getElementById('intent-loss').textContent = d.intent_loss.toFixed?.(5) || d.intent_loss;
  if (d.vocab_size  !== undefined)
    document.getElementById('vocab').textContent = d.vocab_size;
  if (d.episodes    !== undefined)
    document.getElementById('episodes').textContent = d.episodes;
  if (d.trainings   !== undefined)
    document.getElementById('trainings').textContent = d.trainings;
  if (d.queries     !== undefined) {
    document.getElementById('queries').textContent = d.queries;
    document.getElementById('hint').textContent = `${d.queries} consultas Â· ${d.trainings || 0} entrenamientos`;
  }
  if (d.llm_available !== undefined)
    updateLLM(d.llm_available, d.llm_model);
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  LLM BADGE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function updateLLM(available, model) {
  const card   = document.getElementById('llm-card');
  const name   = document.getElementById('llm-name');
  const status = document.getElementById('llm-status');
  if (available) {
    card.classList.add('live');
    name.textContent   = model || 'LLM activo';
    status.textContent = 'Motor de lenguaje conectado';
  } else {
    card.classList.remove('live');
    name.textContent   = 'LLM desconectado';
    status.textContent = 'Configura Groq u Ollama';
  }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  STATS DRAWER
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function openStats() {
  document.getElementById('stats-drawer').classList.add('open');
  document.getElementById('drawer-overlay').classList.add('show');
  document.getElementById('stats-btn').classList.add('active');
  // Solo carga si no estÃ¡ busy y aÃºn no lo ha cargado
  if (!busy) loadStats();
  else document.getElementById('busy-notice').classList.add('show');
}

function closeStats() {
  document.getElementById('stats-drawer').classList.remove('open');
  document.getElementById('drawer-overlay').classList.remove('show');
  document.getElementById('stats-btn').classList.remove('active');
  document.getElementById('busy-notice').classList.remove('show');
}

document.getElementById('stats-btn').addEventListener('click', () => {
  const isOpen = document.getElementById('stats-drawer').classList.contains('open');
  isOpen ? closeStats() : openStats();
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  NUEVO CHAT
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
document.getElementById('new-btn').addEventListener('click', () => {
  conversationId = null;
  const msgs = document.getElementById('messages');
  msgs.innerHTML = `
    <div class="welcome" id="welcome-screen">
      <div class="welcome-glyph">
        <svg viewBox="0 0 24 24" fill="var(--accent)"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26A7 7 0 0 0 19 9c0-3.87-3.13-7-7-7zm1 15h-2v-1h2v1zm.87-3.87c-.31.19-.87.5-.87 1.87h-2c0-2 1.05-2.59 1.57-2.9.56-.34 1.43-.87.43-1.6-.46-.32-.87-.37-1.22-.35-.66.04-1.28.58-1.56 1.35l-1.84-.76C8.87 8.74 10.35 7.1 12.07 7c.67-.04 1.64.06 2.56.71C16.23 8.75 16 10.38 14.04 11.5c-.2.11-.92.54-1.17.63z"/></svg>
      </div>
      <h2>Hola, soy NEXUS</h2>
      <p>Inteligencia artificial con redes neuronales propias y memoria episÃ³dica. Aprendo de cada conversaciÃ³n.</p>
      <div class="suggestions">
        <button class="sug" onclick="sendMessage('Hola! Â¿CÃ³mo estÃ¡s hoy?')">
          <span class="sug-icon">ğŸ‘‹</span><span>SalÃºdame</span>
          <span class="sug-text">Empieza a chatear</span>
        </button>
        <button class="sug" onclick="sendMessage('Â¿CÃ³mo funcionas internamente?')">
          <span class="sug-icon">ğŸ”¬</span><span>CÃ³mo funciono</span>
          <span class="sug-text">Mi arquitectura neural</span>
        </button>
        <button class="sug" onclick="sendMessage('Â¿QuiÃ©n te creÃ³ y cuÃ¡l es tu historia?')">
          <span class="sug-icon">ğŸ‘¤</span><span>Mi creador</span>
          <span class="sug-text">Historia y origen</span>
        </button>
        <button class="sug" onclick="sendMessage('Â¿QuÃ© puedes hacer por mÃ­?')">
          <span class="sug-icon">âš¡</span><span>Capacidades</span>
          <span class="sug-text">Todo lo que puedo hacer</span>
        </button>
      </div>
    </div>`;
  document.getElementById('hint').textContent = 'Nexus estÃ¡ listo';
});

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//  INIT
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
loadStats();       // carga inicial (no hay busy al cargar)
startPolling();    // polling lento que se pausa automÃ¡ticamente si busy
inputEl.focus();
</script>

</body>
</html>
